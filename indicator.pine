//@version=5
// -----------------------------------------------------------------------------
// | Indicator:  EMA System (Optimized Version)                      |
// | Author:     um1ng (Optimized by Professional Trading Advisor)             |
// | Version:    2.0                                                         |
// |---------------------------------------------------------------------------|
// | 这是一款经过优化的综合交易系统指标。包含功能：                              |
// | 1. 多层EMA系统，用于趋势分析。                                             |
// | 2. 基于最长EMA的趋势过滤器（背景颜色）。                                   |
// | 3. ATR值，显示在独立的表格中，用于科学设置止损。                           |
// | 4. 增强的RSI动量警报（进入和退出超买/超卖区域）。                         |
// | 5. 所有视觉元素（EMA线、背景、ATR表）均可独立开关。                        |
// |                                                                           |
// | 重要提示：若要直观查看RSI，请另外在图表中添加内置的"相对强弱指数"指标。     |
// -----------------------------------------------------------------------------

indicator("EMA System (Optimized)", overlay=true, shorttitle="um1ng Pro Max Ultra")

// —————————————————————————————————————————————————————————————————————————————
// Section 1: User Inputs
// 允许您轻松配置指标，无需修改代码。
// —————————————————————————————————————————————————————————————————————————————
string_group_ema = "EMA 设置"
ema_shorter_len = input.int(10, "较短线EMA", group=string_group_ema)
ema_short_len = input.int(20, "短线EMA", group=string_group_ema)
ema_long_len = input.int(50, "长线EMA", group=string_group_ema)
ema_longer_len = input.int(100, "较长线EMA", group=string_group_ema)
ema_holder_len = input.int(200, "趋势过滤EMA (Holder)", group=string_group_ema)

string_group_rsi = "RSI 警报设置"
rsi_len = input.int(14, "RSI 周期", group=string_group_rsi)
rsi_ob = input.int(70, "RSI 超买水平", group=string_group_rsi)
rsi_os = input.int(30, "RSI 超卖水平", group=string_group_rsi)

string_group_atr = "ATR 设置 (用于止损)"
atr_len = input.int(14, "ATR 周期", group=string_group_atr)

string_group_display = "显示设置"
show_ema_shorter = input.bool(true, "显示 较短线EMA", group=string_group_display)
show_ema_short = input.bool(true, "显示 短线EMA", group=string_group_display)
show_ema_long = input.bool(true, "显示 长线EMA", group=string_group_display)
show_ema_longer = input.bool(true, "显示 较长线EMA", group=string_group_display)
show_ema_holder = input.bool(true, "显示 趋势过滤EMA", group=string_group_display)
show_trend_bg = input.bool(true, "显示 趋势背景颜色", group=string_group_display)
show_atr_table = input.bool(true, "显示 ATR信息表", group=string_group_display)


// —————————————————————————————————————————————————————————————————————————————
// Section 2: Calculations
// 此处完成所有必要的指标计算。
// —————————————————————————————————————————————————————————————————————————————
// EMA Calculations
ema_shorter = ta.ema(close, ema_shorter_len)
ema_short = ta.ema(close, ema_short_len)
ema_long = ta.ema(close, ema_long_len)
ema_longer = ta.ema(close, ema_longer_len)
ema_holder = ta.ema(close, ema_holder_len)

// RSI Calculation (for alerts)
rsi_value = ta.rsi(close, rsi_len)

// ATR Calculation
atr_value = ta.atr(atr_len)

// Condition for Trend Filter
is_uptrend = close > ema_holder


// —————————————————————————————————————————————————————————————————————————————
// Section 3: Plotting and Visuals
// 此部分处理指标在图表上的显示方式。
// —————————————————————————————————————————————————————————————————————————————
// Plot EMAs on the chart (with toggles)
plot(show_ema_shorter ? ema_shorter : na, "Shorter EMA", color=color.new(color.green, 0))
plot(show_ema_short ? ema_short : na, "Short EMA", color=color.new(color.orange, 0))
plot(show_ema_long ? ema_long : na, "Long EMA", color=color.new(color.gray, 0))
plot(show_ema_longer ? ema_longer : na, "Longer EMA", color=color.new(color.red, 0))
plot(show_ema_holder ? ema_holder : na, "Holder EMA", color=color.new(color.white, 0), linewidth=2)

// Trend Filter: Change background color based on the main trend (with toggle)
bgcolor(show_trend_bg and is_uptrend ? color.new(color.green, 90) : show_trend_bg ? color.new(color.red, 90) : na, title="Trend Background")

// Display ATR value in a table for stop-loss reference (with toggle)
if show_atr_table
    var table atr_info_table = table.new(position.bottom_right, 1, 1, bgcolor = color.new(color.blue, 70), border_width = 1)
    if barstate.islast
        table.cell(atr_info_table, 0, 0, text="ATR: " + str.tostring(atr_value, "#.####"), text_color=color.white)


